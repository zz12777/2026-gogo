<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 gogo - chuchu & Eddie</title>
    <style>
        :root { 
            --chuchu-bg: #fff9e6; --chuchu-main: #f39c12; 
            --eddie-bg: #f0f7ff; --eddie-main: #4a90e2;  
            --bg: #f8f9fa; --success: #2ecc71; --warn: #ff4d4d;
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 0; }
        #identity-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: #222; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .id-card { padding: 30px; border-radius: 20px; cursor: pointer; text-align: center; transition: 0.3s; margin: 10px; border: 3px solid transparent; width: 150px; }
        .tabs { display: flex; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom: 3px solid #333; color: #333; }
        .content-section { display: none; padding: 20px; max-width: 1100px; margin: 0 auto; }
        .content-section.active { display: block; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .dual-layout { display: flex; gap: 20px; flex-wrap: wrap; }
        .user-box { flex: 1; min-width: 320px; border-radius: 15px; }
        .box-chuchu { background-color: var(--chuchu-bg); border-top: 8px solid var(--chuchu-main); }
        .box-eddie { background-color: var(--eddie-bg); border-top: 8px solid var(--eddie-main); }
        .grid-36 { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; margin-top: 15px; }
        .phase-btn { padding: 8px; border: 1px solid #ddd; border-radius: 8px; text-align: center; cursor: pointer; background: white; font-size: 0.8rem; }
        .phase-btn.selected { background: #333; color: white; }
        .day-row { display: flex; gap: 10px; padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .progress-container { background: #eee; border-radius: 20px; height: 15px; width: 100%; margin: 10px 0; overflow: hidden; }
        .progress-bar { background: var(--success); height: 100%; width: 0%; transition: 0.5s; }
        .header-goal { background: #333; color: white; padding: 12px; text-align: center; border-radius: 8px; margin-bottom: 15px; }
        .nudge-btn { background: var(--warn); color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; display: none; margin: 10px auto; font-weight: bold; }
        .readonly { pointer-events: none; opacity: 0.7; }
        .shaking { animation: shake 0.3s infinite; }
        @keyframes shake { 0%, 100% { transform: translate(0); } 25% { transform: translate(-4px); } 75% { transform: translate(4px); } }
        .display-goal-text { font-size: 1.1rem; font-weight: bold; color: #333; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 8px; white-space: pre-wrap; }
        .input-group { margin-bottom: 10px; flex: 1; }
        label { font-size: 0.9rem; font-weight: bold; display: block; margin-bottom: 5px; }
        textarea:disabled, input:disabled { background: #f9f9f9; color: #666; cursor: not-allowed; }
    </style>
</head>
<body>

<div id="identity-screen">
    <h1>2026 gogo - èº«ä»½ç¢ºèª</h1>
    <div style="display:flex;">
        <div class="id-card" style="background: var(--chuchu-main)" onclick="startApp('chuchu')"><h2>chuchu ğŸ‘§</h2></div>
        <div class="id-card" style="background: var(--eddie-main)" onclick="startApp('eddie')"><h2>Eddie ğŸ‘¦</h2></div>
    </div>
</div>

<div class="tabs">
    <div class="tab active" onclick="showTab(0)">å¹´åº¦ç›®æ¨™</div>
    <div class="tab" onclick="showTab(1)">36é—œå¡è¨­å®š</div>
    <div class="tab" onclick="showTab(2)">æ¯æ—¥ç´€éŒ„</div>
</div>

<section id="tab-0" class="content-section active">
    <h2>ğŸ—“ 2026 å¹´åº¦é¡˜æ™¯æ¿</h2>
    <div class="dual-layout">
        <div class="user-box box-chuchu card">
            <h3>chuchu å¹´åº¦ç›®æ¨™</h3>
            <div id="annual-display-chuchu" class="display-goal-text" style="display:none; min-height:100px;"></div>
            <div id="annual-input-box-chuchu">
                <textarea id="annual-input-chuchu" style="width:100%; height:200px;" placeholder="å¯«ä¸‹å¹´åº¦å¤§ç›®æ¨™..."></textarea>
                <button onclick="saveAnnual('chuchu')" style="width:100%; margin-top:10px; background:#333; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">å„²å­˜å¹´åº¦ç›®æ¨™</button>
            </div>
            <button id="annual-edit-chuchu" onclick="unlockAnnual('chuchu')" style="display:none; width:100%; margin-top:5px;">ä¿®æ”¹å¹´åº¦ç›®æ¨™</button>
        </div>
        <div class="user-box box-eddie card">
            <h3>Eddie å¹´åº¦ç›®æ¨™</h3>
            <div id="annual-display-eddie" class="display-goal-text" style="display:none; min-height:100px;"></div>
            <div id="annual-input-box-eddie">
                <textarea id="annual-input-eddie" style="width:100%; height:200px;" placeholder="å¯«ä¸‹å¹´åº¦å¤§ç›®æ¨™..."></textarea>
                <button onclick="saveAnnual('eddie')" style="width:100%; margin-top:10px; background:#333; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">å„²å­˜å¹´åº¦ç›®æ¨™</button>
            </div>
            <button id="annual-edit-eddie" onclick="unlockAnnual('eddie')" style="display:none; width:100%; margin-top:5px;">ä¿®æ”¹å¹´åº¦ç›®æ¨™</button>
        </div>
    </div>
</section>

<section id="tab-1" class="content-section">
    <div class="header-goal" id="phase-title-setting">è«‹é¸æ“‡ä¸€å€‹éšæ®µ</div>
    <div class="dual-layout">
        <div class="user-box box-chuchu card">
            <h3>chuchu éšæ®µè¨­å®š</h3>
            <div class="grid-36" id="gridA"></div>
            <div id="config-A" style="display:none; margin-top:15px;">
                <div id="goal-display-A" class="display-goal-text"></div>
                <div id="goal-input-A">
                    <div class="input-group">
                        <label>10å¤©ç›®æ¨™å…§å®¹</label>
                        <input type="text" id="t-A" style="width:100%">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <div class="input-group">
                            <label>å–®ä½ (å¦‚:é /æ¬¡)</label>
                            <input type="text" id="u-A">
                        </div>
                        <div class="input-group">
                            <label>ç›®æ¨™ç¸½é‡</label>
                            <input type="number" id="l-A">
                        </div>
                    </div>
                    <button onclick="savePhase('chuchu')" style="width:100%; margin-top:10px; background:#333; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">å„²å­˜ä¸¦é–‹å§‹</button>
                </div>
                <button id="edit-btn-A" onclick="unlockEdit('A')" style="display:none; width:100%; margin-top:5px;">ä¿®æ”¹éšæ®µç›®æ¨™</button>
            </div>
        </div>
        <div class="user-box box-eddie card">
            <h3>Eddie éšæ®µè¨­å®š</h3>
            <div class="grid-36" id="gridB"></div>
            <div id="config-B" style="display:none; margin-top:15px;">
                <div id="goal-display-B" class="display-goal-text"></div>
                <div id="goal-input-B">
                    <div class="input-group">
                        <label>10å¤©ç›®æ¨™å…§å®¹</label>
                        <input type="text" id="t-B" style="width:100%">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <div class="input-group">
                            <label>å–®ä½ (å¦‚:åˆ†é˜/æ¬¡)</label>
                            <input type="text" id="u-B">
                        </div>
                        <div class="input-group">
                            <label>ç›®æ¨™ç¸½é‡</label>
                            <input type="number" id="l-B">
                        </div>
                    </div>
                    <button onclick="savePhase('eddie')" style="width:100%; margin-top:10px; background:#333; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">å„²å­˜ä¸¦é–‹å§‹</button>
                </div>
                <button id="edit-btn-B" onclick="unlockEdit('B')" style="display:none; width:100%; margin-top:5px;">ä¿®æ”¹éšæ®µç›®æ¨™</button>
            </div>
        </div>
    </div>
</section>

<section id="tab-2" class="content-section">
    <div id="current-info-display" class="header-goal">2026 gogo!</div>
    <div class="dual-layout">
        <div class="user-box box-chuchu card" id="main-chuchu">
            <h4 id="today-goal-A">chuchu çš„ç›®æ¨™</h4>
            <div class="progress-container"><div id="bar-A" class="progress-bar"></div></div>
            <p id="sum-text-A">ç›®å‰ç´¯ç©ï¼š0 / 0</p>
            <div id="listA"></div>
            <button id="nudge-chuchu" class="nudge-btn" onclick="sendNudge('chuchu')">âš ï¸ æ•²æ•² chuchuï¼</button>
        </div>
        <div class="user-box box-eddie card" id="main-eddie">
            <h4 id="today-goal-B">Eddie çš„ç›®æ¨™</h4>
            <div class="progress-container"><div id="bar-B" class="progress-bar"></div></div>
            <p id="sum-text-B">ç›®å‰ç´¯ç©ï¼š0 / 0</p>
            <div id="listB"></div>
            <button id="nudge-eddie" class="nudge-btn" onclick="sendNudge('eddie')">âš ï¸ æ•²æ•² Eddieï¼</button>
        </div>
    </div>
</section>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDCQ4mB8c0V57ymosTIg7ihdx7IUZMT4_M",
        authDomain: "gogo-b906a.firebaseapp.com",
        projectId: "gogo-b906a",
        storageBucket: "gogo-b906a.firebasestorage.app",
        messagingSenderId: "206143011059",
        appId: "1:206143011059:web:d347c6f4da8c3498cd5f86"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let me = "";
    let selectedP = 1;
    const startDate = new Date("2026-01-17");

    const goalExamples = [
        { title: "é–±è®€æ›¸ç±", unit: "é ", total: 300 },
        { title: "é–‹è»Šç·´ç¿’", unit: "è¶Ÿ", total: 3 },
        { title: "é¨è»Šå‡ºé–€", unit: "è¶Ÿ", total: 3 },
        { title: "å­¸ä»€éº¼èª²", unit: "é›†", total: 3 },
        { title: "èƒŒå–®å­—", unit: "å€‹", total: 20 },
        { title: "ç·´è‹±æ–‡", unit: "åˆ†é˜", total: 100 }
    ];

    window.startApp = (user) => {
        me = user;
        document.getElementById('identity-screen').style.display = 'none';
        
        const today = new Date();
        const diffDays = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
        selectedP = (diffDays >= 0) ? Math.min(Math.floor(diffDays / 10) + 1, 36) : 1;

        initGrids();
        listenToCloud();
        applyPermissions();
        loadPhaseData(selectedP);
        showTab(2);
    };

    function applyPermissions() {
        const isC = (me === 'chuchu');
        document.getElementById('listA').classList.toggle('readonly', !isC);
        document.getElementById('listB').classList.toggle('readonly', isC);
        document.getElementById('nudge-eddie').style.display = isC ? "block" : "none";
        document.getElementById('nudge-chuchu').style.display = isC ? "none" : "block";
    }

    function initGrids() {
        ['gridA', 'gridB'].forEach(id => {
            const container = document.getElementById(id);
            container.innerHTML = "";
            for (let i = 1; i <= 36; i++) {
                const btn = document.createElement('div');
                btn.className = 'phase-btn' + (i === selectedP ? ' selected' : '');
                let d = new Date(startDate); d.setDate(startDate.getDate() + (i-1)*10);
                let d10 = new Date(d); d10.setDate(d.getDate() + 9);
                btn.innerHTML = `<b>P${i}</b><br><small>${d.getMonth()+1}/${d.getDate()}~${d10.getMonth()+1}/${d10.getDate()}</small>`;
                btn.onclick = () => {
                    selectedP = i;
                    document.querySelectorAll('.phase-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    loadPhaseData(i);
                };
                container.appendChild(btn);
            }
        });
    }

    // --- å¹´åº¦ç›®æ¨™é‚è¼¯ ---
    window.saveAnnual = async (user) => {
        const val = document.getElementById(`annual-input-${user}`).value;
        await setDoc(doc(db, "gogo", "global"), { [`annual_${user}`]: val }, { merge: true });
    };

    window.unlockAnnual = (user) => {
        if (me !== user) return;
        document.getElementById(`annual-input-box-${user}`).style.display = 'block';
        document.getElementById(`annual-display-${user}`).style.display = 'none';
        document.getElementById(`annual-edit-${user}`).style.display = 'none';
    };

    function updateAnnualUI(user, val) {
        const display = document.getElementById(`annual-display-${user}`);
        const inputBox = document.getElementById(`annual-input-box-${user}`);
        const editBtn = document.getElementById(`annual-edit-${user}`);
        const input = document.getElementById(`annual-input-${user}`);

        if (val) {
            display.innerText = val;
            display.style.display = 'block';
            inputBox.style.display = 'none';
            editBtn.style.display = (me === user) ? 'block' : 'none';
        } else {
            display.style.display = 'none';
            inputBox.style.display = (me === user) ? 'block' : 'none';
            editBtn.style.display = 'none';
        }
        input.value = val || "";
    }

    // --- éšæ®µç›®æ¨™é‚è¼¯ ---
    async function loadPhaseData(p) {
        document.getElementById('phase-title-setting').innerText = `æ­£åœ¨è¨­å®šï¼šç¬¬ ${p} éšæ®µ`;
        document.getElementById('config-A').style.display = 'block';
        document.getElementById('config-B').style.display = 'block';
        
        const snap = await getDoc(doc(db, "gogo", `phase_${p}`));
        const data = snap.exists() ? snap.data() : {};
        
        updatePhaseUI('A', data.chuchu);
        updatePhaseUI('B', data.eddie);
        renderDaily('A', data.chuchu, data[`recordsA_${p}`]);
        renderDaily('B', data.eddie, data[`recordsB_${p}`]);
    }

    function updatePhaseUI(suffix, pData) {
        const display = document.getElementById(`goal-display-${suffix}`);
        const inputArea = document.getElementById(`goal-input-${suffix}`);
        const editBtn = document.getElementById(`edit-btn-${suffix}`);
        const myName = (suffix === 'A' ? 'chuchu' : 'Eddie');

        if (pData && pData.target) {
            display.innerText = `${pData.target} (${pData.total} ${pData.unit})`;
            display.style.display = 'block';
            inputArea.style.display = 'none';
            editBtn.style.display = (me === myName) ? 'block' : 'none';
            document.getElementById(`today-goal-${suffix}`).innerText = `${myName} çš„ç›®æ¨™ï¼š${pData.target}`;
        } else {
            display.style.display = 'none';
            inputArea.style.display = (me === myName) ? 'block' : 'none';
            editBtn.style.display = 'none';
            document.getElementById(`today-goal-${suffix}`).innerText = "å°šæœªè¨­å®šç›®æ¨™";
            
            const ex = goalExamples[Math.floor(Math.random() * goalExamples.length)];
            document.getElementById(`t-${suffix}`).placeholder = "ç¯„ä¾‹ï¼š" + ex.title;
            document.getElementById(`u-${suffix}`).placeholder = ex.unit;
            document.getElementById(`l-${suffix}`).placeholder = ex.total;
        }
    }

    window.unlockEdit = (suffix) => {
        document.getElementById(`goal-input-${suffix}`).style.display = 'block';
        document.getElementById(`goal-display-${suffix}`).style.display = 'none';
        document.getElementById(`edit-btn-${suffix}`).style.display = 'none';
    };

    window.savePhase = async (user) => {
        const suffix = user === 'chuchu' ? 'A' : 'B';
        const tIn = document.getElementById(`t-${suffix}`);
        const uIn = document.getElementById(`u-${suffix}`);
        const lIn = document.getElementById(`l-${suffix}`);
        const target = tIn.value || tIn.placeholder.replace("ç¯„ä¾‹ï¼š", "");
        const unit = uIn.value || uIn.placeholder;
        const total = lIn.value || lIn.placeholder;
        await setDoc(doc(db, "gogo", `phase_${selectedP}`), {
            [user]: { target, unit, total }
        }, { merge: true });
        loadPhaseData(selectedP);
        showTab(2);
    };

    // --- æ¯æ—¥ç´€éŒ„é‚è¼¯ ---
    window.renderDaily = (suffix, pData, savedRecords) => {
        const container = document.getElementById('list' + suffix);
        container.innerHTML = "";
        const unit = pData?.unit || "å€¼";
        const total = pData?.total || 0;
        const isEditable = (me === (suffix === 'A' ? 'chuchu' : 'Eddie'));
        let phaseStart = new Date(startDate); phaseStart.setDate(startDate.getDate() + (selectedP - 1) * 10);
        
        for (let d = 0; d < 10; d++) {
            const savedNote = savedRecords?.[d]?.note || "";
            const savedVal = savedRecords?.[d]?.val || "";
            let dDate = new Date(phaseStart); dDate.setDate(phaseStart.getDate() + d);
            const dateStr = `${dDate.getMonth()+1}/${dDate.getDate()} (${["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][dDate.getDay()]})`;
            
            container.innerHTML += `
                <div class="day-row">
                    <div style="font-size:0.8rem; width:80px;">D${d+1}<br>${dateStr}</div>
                    <textarea ${!isEditable ? 'disabled' : ''} onchange="saveDayRecord('${suffix}', ${d})" style="flex:1; height:40px;" placeholder="å¯«æ—¥è¨˜...">${savedNote}</textarea>
                    <input type="number" ${!isEditable ? 'disabled' : ''} oninput="updateProgUI('${suffix}', ${total})" onchange="saveDayRecord('${suffix}', ${d})" style="width:50px;" placeholder="0" value="${savedVal}">
                    <span style="font-size:0.7rem; align-self:center;">${unit}</span>
                </div>`;
        }
        updateProgUI(suffix, total);
        document.getElementById('current-info-display').innerText = `æ­£åœ¨æŸ¥çœ‹ï¼šç¬¬ ${selectedP} éšæ®µ`;
    };

    window.saveDayRecord = async (suffix, dayIdx) => {
        const rows = document.querySelectorAll(`#list${suffix} .day-row`);
        const note = rows[dayIdx].querySelector('textarea').value;
        const val = rows[dayIdx].querySelector('input').value;
        const docRef = doc(db, "gogo", `phase_${selectedP}`);
        const snap = await getDoc(docRef);
        let currentData = snap.exists() ? snap.data() : {};
        let records = currentData[`records${suffix}_${selectedPhase}`] || currentData[`records${suffix}_${selectedP}`] || {};
        records[dayIdx] = { note, val };
        await setDoc(docRef, { [`records${suffix}_${selectedP}`]: records }, { merge: true });
    };

    window.updateProgUI = (s, total) => {
        const inputs = document.querySelectorAll(`#list${s} input`);
        let sum = 0; inputs.forEach(i => sum += Number(i.value || 0));
        const percent = total > 0 ? Math.min(Math.round((sum / total) * 100), 100) : 0;
        document.getElementById(`bar-${s}`).style.width = percent + "%";
        document.getElementById(`sum-text-${s}`).innerText = `ç›®å‰ç´¯ç©ï¼š${sum} / ${total}`;
    };

    function listenToCloud() {
        onSnapshot(doc(db, "gogo", "global"), (snap) => {
            if (!snap.exists()) return;
            const data = snap.data();
            updateAnnualUI('chuchu', data.annual_chuchu);
            updateAnnualUI('eddie', data.annual_eddie);
            if(data.nudgeTarget === me) {
                const panel = document.getElementById('main-' + me);
                panel.classList.add('shaking');
                setTimeout(() => panel.classList.remove('shaking'), 3000);
                updateDoc(doc(db, "gogo", "global"), { nudgeTarget: null });
            }
        });
    }

    window.sendNudge = async (target) => {
        await updateDoc(doc(db, "gogo", "global"), { nudgeTarget: target });
        alert("å·²ç™¼é€æé†’ï¼");
    };

    window.showTab = (i) => {
        document.querySelectorAll('.tab').forEach((t, idx) => t.classList.toggle('active', idx === i));
        document.querySelectorAll('.content-section').forEach((s, idx) => s.classList.toggle('active', idx === i));
    };
</script>
</body>
</html>